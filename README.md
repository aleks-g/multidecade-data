<!--
SPDX-FileCopyrightText: 2022 Koen van Greevenbroek & Aleksander Grochowicz

SPDX-License-Identifier: CC-BY-4.0
-->

# Summary
This repository contains demand and hydropower generation data based on historical weather and generation data for the years 1980-2020. 
It was generated for [investigating weather variability](https://github.com/aleks-g/intersecting-near-opt-spaces), using [PyPSA-Eur](https://github.com/PyPSA/pypsa-eur).

The hydro data is based on historical generation and capacity data by the US Energy Information Administration (EIA); the generation was scaled up to 2020 capacity levels in order to isolate only the changes due to weather variability.

The demand data is artificially generated using a regression model on 1980-2020 ERA5 temperature data. 
It is trained with ENTSO-E data from 2010 and 2014 and the corresponding temperature, all based on hourly country-level data.

For brevity, we use [ISO 3166-1 alpha-2](https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2) two-letter codes to identify countries.

# Data
## Hydro data
The hydro data here is an extension of the data used in PyPSA-Eur. 
It contains country-level annual generation values (1980-2020) and hydropower capacities (1980-2020).
All generation values are scaled up to 2020 capacities, meaning that each historical generation value is scaled by the ratio of current to historical installed capacity at the time.
This crude approach (due to lack of more spatially refined data) still makes it possible to consider inter-annual variability of hydro generation.

The EIA considers formerly existing countries, so it is possible to approximate historical generation data within current country borders also before those countries existed.
For Germany, we sum the generation (and capacity) levels of 1980-1990 of West and East Germany.
For the former Czechoslovakia and Yugoslavia we use the capacity data of the first year of new borders to obtain relative capacities and generation.
For example, the capacity of CZ in 1993 is 911 MW, and 925 MW of Slovakia, corresponding to 49.6 and 50.4 percent resp. of the total capacity.
These values are used to calculate both generation and capacities for 1980-1992 for CZ and SK.
The same is done for HR, SI, MK, BA (1992), MT, RS (2006/2008).

For the Baltic countries (EE, LT, LV) we keep the 1992 values constant for the years 1980-1991, as their share of hydropower of the former Soviet Union is negligible.

Therefore, for every country $c$, the generation for year $y = 1980,\dots,2020$ is

$$
\text{gen}\_y = \text{gen-nom}\_y \cdot \frac{\text{cap}\_{2020}}{\text{cap}\_y},
$$

where
| Variable   | Description                                                              |
|-----------------|--------------------------------------------------------------------------|
| $\text{gen\-nom}\_y$             | the hydro electricity generation according to the EIA in year $y$                                     |
| $\text{cap}\_{2020}$        | the hydro generation capacity in  2020                                        |
| $\text{cap}\_y$        | the hydro generation capacity in year  $y$.                           |

These annual total generation sums serve as scaling factors in PyPSA-Eur for the hydro inflow profile generated by [Atlite](https://github.com/PyPSA/atlite/) using ERA5 reanalysis data.

The above calculations are performed in [this spreadsheet](hydro data/calculations_scaling_hydro_data.ods).


## Demand data
### Approach
The main idea behind the approach is to separate temperature-dependent electricity demand from the load that is not driven by temperature. 
This is done with methods from time series analysis, based on openly available ENTSO-E load data for 2010-2014 and validated on the same sources for 2015.

We consider 31 countries: ['AT', 'BE', 'BG', 'CH', 'CZ', 'DE', 'DK', 'EE', 'ES', 'FI', 'FR', 'UK', 'EL', 'HR', 'HU', 'IE', 'IT', 'LT', 'LU', 'LV', 'ME', 'MK', 'NL', 'NO', 'PL', 'PT', 'RO', 'RS', 'SE', 'SI', 'SK']. 
For all of these countries, we only have missing values in the training data at the periods of daylight savings time (so one Sunday 2:00 in March), and for Greece (with 96 hours missing in the validation year).
There are no additional data gaps, although it is possible that the dataset contains some faulty points.

### Mathematical description
Consider the following variables:
| Variable/set                     | Description                                                             |
|----------------------------------|-------------------------------------------------------------------------|
| $C$                              | The set of countries as above                                           |
| $D\_c(t)$                        | Load in country $c$ at time $t$                                         |
| $T\_c(t)$                        | Average temperature in country $c$ in time $t$                          |
| $h$, $d$                         | Hour $h$ of day $d$ (breaking $t$ down into days and hours)             |
| $\text{threshold}\_{\text{CDD}}$ | Average daily temperature above which it is assumed that cooling starts |
| $\text{threshold}\_{\text{HDD}}$ | Average daily temperature below which it is assumed that heating starts |

Consider two disjoint intervals 

$$
I\_{\text{train}} = [t\_0, t\_1] \text{ and } I\_{\text{val}} = [t\_2, t\_3]
$$

for which we have demand data 

$$
\begin{align*}
D\_{\text{train}} &= \left(D\_c(t)\right)\_{c \in \text{countries}, t\_0 \leq t \leq t\_1} \\
D\_{\text{test}} &= \left(D\_c(t)\right)\_{c \in \text{countries}, t\_2 \leq t \leq t\_3}
\end{align*}
$$

and temperature data 

$$
\begin{align*}
T\_{\text{train}} &= \left(T\_c(t)\right)\_{c \in \text{countries}, t\_0 \leq t \leq t\_1} \\
T\_{\text{test}} &= \left(T\_c(t)\right)\_{c \in \text{countries}, t\_2 \leq t \leq t\_3}.
\end{align*}
$$

The goal is to obtain a decomposition of demand as follows:

$$
\begin{align}
D\_c(t) = D^{\text{temp-ind.}}\_c(t) + D\_c(t, T\_c(t)) 
\end{align}
$$

for all countries $c$ and times $t$.

We construct this first for the training data, and thus for the time being neglect the notational difference between $D\_{\text{test}}$ and $D\_{\text{train}}$. 
We will always look at all chosen countries $c \in C$ and time steps $t \in I\_{\text{train}}$. 
We first construct weekly load profiles via regression: 
First, we normalise the hourly demand values with the daily average value, i.e. $D^{\text{norm}}\_c(h) = \frac{D\_c(h)}{\overline{D\_c(d)}}$. 
On those we conduct a regression:

$$
D^{\text{norm}}\_c(t) = \alpha_c \cdot t + \sum\_{i = 1}^{168} \delta\_{i, t \bmod 168} \cdot \alpha\_{i, c}
$$

Here, $\alpha_c$ is a per-country annual linear trend variable.
All in all, we are able to create weekly profiles that are independent of temperatures and actual demand values.

The next step is to introduce the temperature-driven components. 
This we do by assuming that electricity demand is both driven by heating and cooling demand, and that there is some thermal intertia in buildings/people's behaviour. 
In that sense, we follow the common concept of *Heating degree days* (HDD) and *Cooling degree days* (CDD), where a threshold (or one each) for daily average temperature is set:

$$
\begin{align}
CDD\_c(d) &= \max\\{T\_c(d) - \text{threshold}\_{\text{CDD}}, 0\\}, \\
HDD\_c(d) &= \max\\{\text{threshold}\_{\text{HDD}} - T\_c(d), 0\\},
\end{align}
$$

where $T_c(d)$ is daily average temperature in country $c$ during day $d$.

We use the threshold defined by the EU at 15.5 degrees Celsius.
Afterwards we aggregate both demand and temperature data to daily values (due to our thermal inertia assumption and for consistency reasoning, as cold summer nights, hot summer days) and conduct a regression on daily values with dummy variables for each day of the week, a period of 365 (for each year), and exogenous variables given by heating degrees and cooling degrees:

$$
\begin{align}
D\_c(d) = \beta\_{\text{weekday}(d)} + \beta\_{\text{cooling}} \cdot CDD\_c(d) + \beta\_{\text{heating}} \cdot HDD\_c(d) 
\end{align}
$$

Here, the "weekday" of a holiday is set to be Sunday.
Specifically, we classify public holidays and the period between December 24 and January 2 for countries with the Gregorian calendar, and January 6 to January 8 for countries with the Julian calendar (to capture the Christmas break and Orthodox Christmas in Montenegro, North Macedonia, and Serbia) as Sundays.
For both regressions, we perform a statistical significance test and set the regression parameter to zero if its two-tailed $p$-value is above 0.025. 
This only occurs for some countries for the trend parameter  ${\alpha_c}$
and
$\beta\_{\text{cooling}}$.

With the necessary regressions in place, we can construct our artificial demand data for other years/weather conditions:

$$
D^{\text{artificial}}\_c(t) = \alpha\_{c, t \bmod 168} \cdot \left[\alpha\_c \cdot (t \bmod 8760) + \beta\_{c, \text{weekday}(d)} + \beta^{\text{cooling}}\_c \cdot CDD\_c(d) + \beta^{\text{heating}}\_c \cdot HDD\_c(d)\right].
$$

The same way we validate our data for a validation, out-of-sample year.

### Validation
Since the demand and temperature data for 2015 is available for all countries in a consistent way (except Greece with four days in August), it is chosen to be the validation year for the regressions that were trained with 2010-2014 data.
We compare the Pearson correlation coefficient between hourly artificial demand and actual measured load for each country. 
Additionally, we look at RMSE and its share of the mean of all hourly values.

|     Value                  |     AT |     BE |     BG |     CH |     CZ |      DE |     DK |    EE |      ES |     FI |      FR |      UK |     EL |     HR |     HU |     IE |      IT |    LT |    LU |    LV |    ME |    MK |     NL |      NO |     PL |     PT |     RO |     RS |     SE |    SI |     SK |
|-----------------------|--------|--------|--------|--------|--------|---------|--------|-------|---------|--------|---------|---------|--------|--------|--------|--------|---------|-------|-------|-------|-------|-------|--------|---------|--------|--------|--------|--------|--------|-------|--------|
| Corr                  |   0.97 |   0.94 |   0.88 |   0.93 |   0.96 |    0.97 |   0.95 |  0.96 |    0.95 |   0.94 |    0.95 |    0.91 |   0.89 |   0.93 |   0.95 |   0.93 |    0.94 |  0.97 |  0.74 |  0.97 |  0.91 |  0.93 |   0.94 |    0.93 |   0.96 |   0.95 |   0.92 |   0.95 |   0.95 |  0.94 |   0.94 |
| RMSE                  | 528.1  | 551.2  | 422.1  | 392.4  | 404.5  | 3275.2  | 298.2  | 58.1  | 1980.3  | 480.3  | 3624.7  | 3442.6  | 931.8  | 133.5  | 264.7  | 227.4  | 3070.8  | 61.2  | 94.8  | 49.5  | 38.3  | 78.8  | 775.6  | 1038.9  | 804.9  | 389.2  | 415.1  | 301.3  | 900.7  | 91.6  | 154.2  |
| Hourly avg. RMSE in % |   6.4  |   5.8  |  10    |   5.5  |   5.7  |    5.7  |   8.1  |  6.6  |    7.3  |   5.2  |    6.8  |    8.9  |  18.3  |   7    |   5.9  |   7.7  |    8.7  |  5    | 14.3  |  6    | 10.4  |  8.5  |   6    |    7.2  |   4.8  |   7.3  |   7.2  |   6.8  |   5.9  |  6    |   4.9  |'

Additional short validations that were done:
- Checking for statistical significance of parameters,
- Checking for different thresholds of heating and cooling degree days (if the latter is chosen to be any integer value between 16 and 19, there seems to be very little change in performance),
- Possibly inclusion of different regressions for each countries and varying thresholds, or already including the holidays as a Sunday or additional day at an earlier stage.

Additional validation was conducted through comparison with the estimated values in Thomaßen et al. 
There the COP is also included and an estimated annual demand for electric heating.

Furthermore, the obtained electric heating demand for each country in the EU is compared to the one given in JRC-IDEES: 
This is the deviation in percent of the estimated electric heating demand from the official electric heating demand for 2015:
|   AT |   BE |   BG |   CZ |   DE |   DK |   EE |   ES |   FI |   FR |   UK |   EL |   HR |   HU |   IE |   IT |   LT |   LU |   LV |   NL |   PL |   PT |   RO |   SE |   SI |   SK |
|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|------|
|   35 |  -31 |  112 |  -15 |  -39 |   86 |   16 |  -30 |    6 |   25 |  -31 |  -10 |    9 |   -5 |   22 |  -54 |   68 |  -65 |   56 |  -21 |  -31 |  -42 |   92 |   40 |  -42 |    7 |


# Data sources
## Hydro data
Hydropower generation and capacity data from the U.S. Energy Information Administration (EIA):
https://www.eia.gov/international/data/world/electricity/electricity-generation
(accessed 24/11/2021)

## Demand data
Training data from ENTSO-E between 2010 and 2015 (except Switzerland): (Greece's 31-12-2015 23:00 is just 22:00 duplicated)
https://eepublicdownloads.blob.core.windows.net/public-cdn-container/clean-documents/Publications/Statistics/Monthly-hourly-load-values_2006-2015.xlsx
(accessed 24/11/2021)

Training data from Swissgrid between 2010 and 2015 for Switzerland:
https://www.swissgrid.ch/en/home/operation/grid-data/generation.html#total-energy-consumption (from the Energy Statistics: > Zeitreihen0h15, 'Summe verbrauchte Energie Regelblock Schweiz / Total energy consumption Swiss controlblock')
(accessed 24/11/2021)

JRC-IDEES: Integrated Database of the European Energy Sector: Methodological note
Mantzos, L., Wiesenthal, T., Matei, N., Tchung-Ming, S., Rózsai, M., Russ, H. and Soria Ramirez, A., JRC-IDEES: Integrated Database of the European Energy Sector: Methodological note , EUR 28773 EN, Publications Office of the European Union, Luxembourg, 2017, ISBN 978-92-79-73465-6, doi:10.2760/182725, JRC108244.
http://jeodpp.jrc.ec.europa.eu/ftp/jrc-opendata/JRC-IDEES/JRC-IDEES-2015_v1/ (for each country > JRC-IDEES-2015_EnergyBalance_XX.xlsx > [Residential: Space heating > Electricity + Services: Space heating > Electricity]
(accessed 24/11/2021)

Holidays for the given countries (except Cyprus which seems to have the same public holidays in Greece, so just copied):
https://github.com/dr-prodigy/python-holidays


# Licenses
All code in this repository is released under the GPL-3.0 or later license.
All data generated in this repository is released under the CC-BY-4.0 license.

For the licenses under which the input data are available, we refer to their respective sources.


# References
Similar approach used in
Bloomfield, Hannah, Brayshaw, David and Charlton-Perez, Andrew (2020): ERA5 derived time series of European country-aggregate electricity demand, wind power generation and solar power generation: hourly data from 1979-2019. University of Reading. Dataset. http://dx.doi.org/10.17864/1947.272

Bloomfield, H. C., Brayshaw, D. J., Shaffrey, L. C., Coker, P. J. and Thornton, H. E. (2016) Quantifying the increasing sensitivity of power systems to climate variability. Environmental Research Letters, 11 (12). 124025. ISSN 1748-9326 

Additional validation (and also similar approach, just with heat pump COP):
Thomaßen, G et al (2021): The decarbonisation of the EU heating sector through electrification: A parametric analysis. Energy Policy (148, Part A). https://doi.org/10.1016/j.enpol.2020.111929
